"use strict";var K=Object.create;var E=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var X=Object.getPrototypeOf,Y=Object.prototype.hasOwnProperty;var Z=(e,t)=>{for(var r in t)E(e,r,{get:t[r],enumerable:!0})},H=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Q(t))!Y.call(e,s)&&s!==r&&E(e,s,{get:()=>t[s],enumerable:!(o=z(t,s))||o.enumerable});return e};var a=(e,t,r)=>(r=e!=null?K(X(e)):{},H(t||!e||!e.__esModule?E(r,"default",{value:e,enumerable:!0}):r,e)),ee=e=>H(E({},"__esModule",{value:!0}),e);var le={};Z(le,{bail:()=>G,build:()=>oe,compilation:()=>c,corePresets:()=>ne,executor:()=>M,getConfig:()=>L,overridePresets:()=>ae,start:()=>ie});module.exports=ee(le);var l=require("path"),O=require("fs-extra"),C=a(require("express")),y=require("@storybook/node-logger"),k=require("@fal-works/esbuild-plugin-global-externals"),I=require("@yarnpkg/esbuild-plugin-pnp"),U=a(require("esbuild-plugin-alias"));var S=a(require("path")),v=require("fs-extra"),q=require("ejs");var te=async e=>(0,S.join)((0,S.dirname)(require.resolve("@storybook/builder-manager/package.json")),"templates",e),_=async e=>{let t=await te(e);return(0,v.readFile)(t,"utf8")};var j=async(e,t,r,o,s,n,i,u,m,{versionCheck:p,releaseNotesData:h,docsMode:b,previewUrl:R,serverChannelUrl:d})=>{let g=await r,f=await t,x=await e;return(0,q.render)(x,{title:f?`${f} - Storybook`:"Storybook",files:{js:s,css:o},globals:{FEATURES:JSON.stringify(await n,null,2),REFS:JSON.stringify(await i,null,2),LOGLEVEL:JSON.stringify(await u,null,2),DOCS_OPTIONS:JSON.stringify(await m,null,2),VERSIONCHECK:JSON.stringify(JSON.stringify(p),null,2),RELEASE_NOTES_DATA:JSON.stringify(JSON.stringify(h),null,2),PREVIEW_URL:JSON.stringify(R,null,2),SERVER_CHANNEL_URL:JSON.stringify(d,null,2)},head:g?await(0,v.readFile)(g,"utf8"):""})};var N=require("@storybook/ui/dist/globals");var A=require("path"),V=require("@storybook/core-common");var F=e=>{try{return Promise.resolve(require.resolve(e))}catch{return Promise.resolve(!1)}};var T=async e=>{let t=(0,V.getRefs)(e),r=e.presets.apply("features"),o=e.presets.apply("logLevel"),s=e.presets.apply("title"),n=e.presets.apply("docs",{}),i=_("template.ejs"),u=F((0,A.join)(e.configDir,"manager-head.html")),[m,p]=await Promise.all([M.get(),L(e)]);return{refs:t,features:r,title:s,docsOptions:n,template:i,customHead:u,instance:m,config:p,logLevel:o}};var P=require("fs-extra");async function J(e){var s,n;let t=await Promise.all(((n=(s=c)==null?void 0:s.outputFiles)==null?void 0:n.map(async i=>(await(0,P.ensureFile)(i.path).then(()=>(0,P.writeFile)(i.path,i.contents)),i.path.replace(e,"./sb-addons"))))||[]),r=t.filter(i=>i.endsWith(".mjs"));return{cssFiles:t.filter(i=>i.endsWith(".css")),jsFiles:r}}var c,w,L=async e=>{let[t,r]=await Promise.all([e.presets.apply("managerEntries",[]),F((0,l.join)(e.configDir,"manager"))]);return{entryPoints:r?[...t,r]:t,outdir:(0,l.join)(e.outputDir||"./","sb-addons"),format:"esm",write:!1,outExtension:{".js":".mjs"},loader:{".js":"jsx",".png":"dataurl",".gif":"dataurl",".jpg":"dataurl",".jpeg":"dataurl",".svg":"dataurl",".webp":"dataurl",".webm":"dataurl"},target:["chrome100"],platform:"browser",bundle:!0,minify:!1,sourcemap:!0,legalComments:"external",plugins:[(0,U.default)({process:require.resolve("process/browser.js"),util:require.resolve("util/util.js"),assert:require.resolve("browser-assert")}),(0,k.globalExternals)(N.definitions),(0,I.pnpPlugin)()],define:{"process.env.NODE_ENV":"'production'","process.env":"{}",global:"window",module:"{}"}}},M={get:async()=>{let{build:e}=await import("esbuild");return e}},re=async function*({startTime:t,options:r,router:o}){y.logger.info("=> Starting manager..");let{config:s,customHead:n,features:i,instance:u,refs:m,template:p,title:h,logLevel:b,docsOptions:R}=await T(r);yield;let d=s.outdir;await(0,O.remove)(d),yield,c=await u({...s,watch:!0}),yield;let g=(0,l.join)((0,l.dirname)(require.resolve("@storybook/ui/package.json")),"dist");o.use("/sb-addons",C.default.static(d)),o.use("/sb-manager",C.default.static(g));let{cssFiles:f,jsFiles:x}=await J(d);yield;let D=await j(p,h,n,f,x,i,m,b,R,r);return yield,o.use("/",({path:B},W,$)=>{B==="/"?W.status(200).send(D):$()}),{bail:G,stats:{toJson:()=>({})},totalTime:process.hrtime(t)}},se=async function*({startTime:t,options:r}){if(!r.outputDir)throw new Error("outputDir is required");y.logger.info("=> Building manager..");let{config:o,customHead:s,features:n,instance:i,refs:u,template:m,title:p,logLevel:h,docsOptions:b}=await T(r);yield;let R=o.outdir,d=(0,l.join)((0,l.dirname)(require.resolve("@storybook/ui/package.json")),"dist"),g=(0,l.join)(r.outputDir,"sb-manager");c=await i({...o,minify:!0,watch:!1}),yield;let f=(0,O.copy)(d,g),{cssFiles:x,jsFiles:D}=await J(R);yield;let B=await j(m,p,s,x,D,n,u,h,b,r);return await Promise.all([(0,O.writeFile)((0,l.join)(r.outputDir,"index.html"),B),f]),y.logger.trace({message:"=> Manager built",time:process.hrtime(t)}),{toJson:()=>({})}},G=async()=>{if(w)try{await w.throw(new Error)}catch{}if(c&&c.stop)try{c.stop(),y.logger.warn("Force closed manager build")}catch{y.logger.warn("Unable to close manager build!")}},ie=async e=>{w=re(e);let t;do t=await w.next();while(!t.done);return t.value},oe=async e=>{w=se(e);let t;do t=await w.next();while(!t.done);return t.value},ne=[],ae=[];0&&(module.exports={bail,build,compilation,corePresets,executor,getConfig,overridePresets,start});
